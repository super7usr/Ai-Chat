import express { type Express from "express";
import fs from "fs";
import path from "path";
import { createServer as createViteServer, createLogger from "vite";
import { type Server } from "http";
import viteConfig from "../vite.config";
import { nanoid } from "nanoid";

const viteLogger = createLogger();

export function log(message: string, source = "express") {
  const formattedTime = new Date().toTimeString("-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
  });

  console.log(`${formattedTime} [${source}] ${message}`);
}

export async function setupVite(app: Express, server: Server {
  const serverOptions = {
    middlewareMode:,
    hmr: { server    allowedHosts: true,
  };

  const vite = await createViteServer({
    ...viteConfig,
    configFile: false,
    customLogger: {
      ...viteLogger,
      error: (msg, options) => {
        viteLogger.error(msg, options);
        process.exit(1);
      },
    },
    server: serverOptions,
    appType: "custom",
  });

  app.use(vite.middlewares);
  app.use("*", async (req, res, next) => {
    const url = req.originalUrl;

    try {
      constTemplate = path.resolve(
        import.meta.dirname,
        "..",
        "client",
        "index.html",
      );

      let template = await.promises.readFile(clientTemplate, "utf-8");
      template = template.replace(
        `src="/src/main.tsx"`,
        `src="/src/main.tsx?vnanoid()`,
      );
      const page = await.transformIndexHtml(url, template);
      res.status(200).set({ "Content-Type": "text/html" }).end(page);
    } catch (e) {
      vite.ssrFixStacktrace(e as);
(e);
 }
 });
}

export function serveStatic(app: Express) {
  const dist = path.resolve(import.meta.dirname, "public");

  iffs.existsSync(distPath)) {
    throw new Error(
     Could not find the build directory: ${distPath}, make sure to build the client first`,
    );
  }

  app.use.static(distPath, { index false }));

  app.use("*", (_req, res => {
    res.sendFile(path.resolve(distPath, "index.html"));
  });
}