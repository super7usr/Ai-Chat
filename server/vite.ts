import express, { type Express } from "express";
import fs from "fs";
import path from "path";
import { createServer as createViteServer, createLogger } from "vite";
import { type Server } from "http";
import viteConfig from "../vite.config";
import { nanoid } from "nanoid";
const viteLogger = createLogger();

export function log(message: string, source = "express") {
  const formattedTime = new Date().toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
  });
  console.log(`${formattedTime} [${source}] ${message}`);
}

// Helper to detect if we're running in a Cloudflare Pages environment
function isCloudflarePages(): boolean {
  // Cloudflare Pages sets specific env vars
  return (
    process.env.CF_PAGES === "1" ||
    process.env.CLOUDFLARE_PAGES === "1" ||
    process.env.KV_NAMESPACE !== undefined || // Often set in CF Pages
    process.env.CF_PAGES_URL !== undefined
  );
}

export async function setupVite(app: Express, server: Server) {
  const serverOptions = {
    middlewareMode: true,
    hmr: { server },
    allowedHosts: true,
  };
  const vite = await createViteServer({
    ...viteConfig,
    configFile: false,
    customLogger: {
      ...viteLogger,
      error: (msg, options) => {
        viteLogger.error(msg, options);
        process.exit(1);
      },
    },
    server: serverOptions,
    appType: "custom",
  });

  app.use(vite.middlewares);

  app.use("*", async (req, res, next) => {
    const url = req.originalUrl;
    try {
      // Use process.cwd() instead of import.meta.dirname for compatibility (Node and Cloudflare)
      const clientDir = path.resolve(process.cwd(), "client");

      // Default to index.html in "client"
      const clientTemplate = path.resolve(clientDir, "index.html");

      // always reload the index.html file from disk in case it changes
      let template = await fs.promises.readFile(clientTemplate, "utf-8");
      template = template.replace(
        `src="/src/main.tsx"`,
        `src="/src/main.tsx?v=${nanoid()}"`,
      );
      const page = await vite.transformIndexHtml(url, template);
      res.status(200).set({ "Content-Type": "text/html" }).end(page);
    } catch (e) {
      vite.ssrFixStacktrace(e as Error);
      next(e);
    }
  });
}

export function serveStatic(app: Express) {
  // Use process.cwd() instead of import.meta.dirname for compatibility on Cloudflare
  const distPath = path.resolve(process.cwd(), "public");
  if (!fs.existsSync(distPath)) {
    throw new Error(
      `Could not find the build directory: ${distPath}, make sure to build the client first`,
    );
  }

  // Important for Cloudflare Pages: ensure the correct headers are set,
  // including a fallback for SPA routes
  app.use(
    express.static(distPath, {
      setHeaders: (res, filePath) => {
        // Security headers for static assets res.setHeader("Cross-Origin-Embedder-Policy", "credentialless");
        res.setHeader("Cross-Origin-Opener-Policy", "same-origin");
        // On Cloudflare Pages, caching behavior may differ - let CF handle cache
        if (/\.(js|css|jpg|jpeg|png|svg|webp|ico|woff|woff2|ttf)$/.test(filePath)) {
          res.setHeader("Cache-Control", "public, max-age=31536000, immutable");
        } else {
          res.setHeader("Cache-Control", "no-cache");
        }
      },
    }),
  );

  // For SPA: fallback to index.html
  app.use("*", (_req, res) => {
    res.sendFile(path.resolve(distPath, "index.html"));
  });
}